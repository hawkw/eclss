<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ECLSS</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
<link rel="stylesheet" href="https://iosevka-webfonts.github.io/iosevka/iosevka.css" /> 
<script src="//code.iconify.design/1/1.0.6/iconify.min.js"></script>
<style type="text/css">
    /* tr.reading td {
        border-bottom: 2px solid lightgrey;
    }

    tr.reading td.kind {
        font-weight: bold;
    } */
    .reading.value {
        font-family: 'Iosevka Web';
    }

    p#temp .value.celcius::after {
        content:  " \00B0 C";
    }
    p#temp .value.fahrenheit::after {
        content:  " \00B0 F";
    }

    p#co2 .value::after {
        content: " ppm";
    }

    p#pressure .value::after {
        content: " hPa";
    }

    p#humidity .value::after {
        content: "%";
    }

    p#gas_resistance .value::after {
        content: " \2126";
    }
    </style>
    <script>
        var fahrenheit = false;

        async function updateSsids() {
            try {
                const ssids = await fetch('/wifi/ssids.json')
                    .then((response) => response.json());
                console.log(ssids);
                const ssidSelect = document.getElementById('ssids');
                ssids.forEach( ssid => {
                    let option = document.createElement("option");
                    option.textContent = ssid;
                    ssidSelect.appendChild(option);
                })
            } catch(error) {
                console.error('Error updating SSIDs: ', error);
            }
        }

        async function updateSensors() {
            const readingClasses = "reading value is-size-1-widescreen has-text-weight-bold"
            class Reading {
                value;
                classes;

                constructor(key, value) {
                    if (key == 'temp') {
                        if (fahrenheit) {
                            this.classes = readingClasses + ' fahrenheit';
                            this.value = celciusToFahrenheit(value).toFixed(2);
                        } else {
                            this.classes = readingClasses + ' celcius';
                            this.value = value.toFixed(2);
                        }
                    } else {
                        this.classes = readingClasses;
                        this.value = value.toFixed(2);
                    }
                }
            }

            try {
                const sensors = await fetch('/sensors.json').then((response) => response.json());

                console.log(sensors);
                for (const key in sensors) {
                    if (sensors.hasOwnProperty(key)) {
                        const reading = sensors[key];
                        const element = document.getElementById(key);
                        if (element) {
                            if (reading.hasOwnProperty('value')) {
                                // single sensor reading
                                let r = new Reading(key, reading.value);
                                element.innerHTML = `<span class='${r.classes} has-text-centered'>${r.value}</span>`;
                            } else {
                                let html = '';
                                for (const sensorName in reading) {
                                    if (reading.hasOwnProperty(sensorName)) {
                                        let sensor = reading[sensorName];
                                        let r = new Reading(key, sensor.value);
                                        html += `<span class='${r.classes} has-text-right'>${r.value}</span><span class='tag has-text-left'>${sensor.sensor}</span><br />`;
                                    }
                                }
                                element.innerHTML = html;
                            }
                        } else {
                            console.warn("No element named: ", key)
                        }
                    }
                }

            } catch(error) {
                console.error('Error updating sensor readings: ', error);
            }
        }

        function setFahrenheit() {
            fahrenheit = true;
            makeSelected(document.getElementById('temp-f').classList);
            makeUnselected(document.getElementById('temp-c').classList);
            console.log("Set temperature readings to Fahrenheit");
        }

        function setCelcius() {
            fahrenheit = false;
            makeSelected(document.getElementById('temp-c').classList);
            makeUnselected(document.getElementById('temp-f').classList);
            console.log("Set temperature readings to Celcius");
        }

        function makeSelected(classes) {
            classes.add('is-selected');
            classes.add('is-primary');
        }


        function makeUnselected(classes) {
            classes.remove('is-selected');
            classes.remove('is-primary');
        }

        function celciusToFahrenheit(celcius) {
            return celcius * (9 / 5) + 32;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Get all "navbar-burger" elements
            const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

            // Add a click event on each of them
            $navbarBurgers.forEach( el => {
                el.addEventListener('click', () => {

                    // Get the target from the "data-target" attribute
                    const target = el.dataset.target;
                    const $target = document.getElementById(target);

                    // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
                    el.classList.toggle('is-active');
                    $target.classList.toggle('is-active');

                });
            });
        });

        setInterval(updateSensors, 2000);
        updateSensors();
        updateSsids();
    </script>
</head>
<body>
    <nav class="navbar" role="navigation" aria-label="dropdown navigation">
        <div class="navbar-start">
            <div class="navbar-item">
                <p class="title">ECLSS</p>
            </div>

            <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>


        <div class="navbar-end">
            <div class="navbar-item">
                <div class="field has-addons">
                    <p class="control">
                      <button class="button is-selected is-primary" id="temp-c" onclick="setCelcius();">
                        <span class="has-text-weight-bold">&#xb0; C</span>
                      </button>
                    </p>
                    <p class="control">
                        <button class="button" id="temp-f" onclick="setFahrenheit();">
                          <span class="has-text-weight-bold">&#xb0; F</span>
                        </button>
                      </p>
                </div>
            </div>
        </div>
    </nav>
    <section class="hero is-primary">
        <div class="hero-body">
            <h1 class="title">
                ECLSS
            </h1>
            <p class="subtitle">
                Environmental Controls and Life Support Systems
            </p>
        </div>
    </section>
    <section class = "section">
        <nav class="level">
            <div class="level-item">
              <div class = ".reading">
                <p class="heading has-text-centered">
                    <span class="icon-text">
                        <span class="icon iconify" data-icon="mdi-temperature"></span>
                        <span>Temperature</span>
                    </span>
                </p>
                <p class="title" id="temp">--</p>
              </div>
            </div>
            <div class="level-item">
              <div class = ".reading">
                <p class="heading has-text-centered">
                    <span class="icon-text">
                        <span class="icon iconify" data-icon="mdi-molecule-co2"></span>
                        <span>Carbon Dioxide</span>
                    </span>
                <p class="title" id="co2">--</p>
              </div>
            </div>
            <div class="level-item">
                <div class = ".reading">
                    <p class="heading has-text-centered">
                        <span class="icon-text">
                            <span class="icon iconify" data-icon="mdi-cloud-download"></span>
                            <span>Barometric Pressure</span>
                        </span>
                    </p>
                    <p class="title" id="pressure">--</p>
                </div>
            </div>
            <div class="level-item">
                <div class = ".reading">
                    <p class="heading has-text-centered">
                        <span class="icon-text">
                            <span class="icon iconify" data-icon="mdi-water-percent"></span>
                            <span>Relative Humidity</span>
                        </span>
                    </p>
                    <p class="title" id="humidity">--</p>
                </div>
            </div>
            <div class="level-item">
                <div class = ".reading">
                    <p class="heading  has-text-centered">
                        <span class="icon-text">
                            <span class="icon iconify" data-icon="mdi-spray"></span>
                            <span>VOC Sensor Resistance</span>
                        </span>
                    </p>
                    <p class="title" id="gas_resistance">--</p>
                </div>
            </div>
          </nav>
    </section>

    <section class = "section">
        <div class = "panel">
            <p class="panel-heading">
                <span class="icon-text">
                    <span class="icon iconify" data-icon="mdi-wifi-cog"></span>
                    <span>WiFi</span>
                </span>
            </p>
            <div class="panel-block">
                <form
                    method="post" action="/wifi/select"
                    enctype="application/x-www-form-urlencoded">
                    <div>
                        <div class="field">
                            <label class="label">Access Point (SSID)</label>
                            <div class="control has-icons-left">
                                <span class="select">
                                    <select name="ssid" id="ssids"></select>
                                </span>
                                <span class="icon is-small is-left iconify" data-icon="mdi-access-point-network"></span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="field">
                            <label class="label">Password</label>
                            <div class="control has-icons-left">
                                <input
                                    class="input"
                                    type="password"
                                    pattern=".{{8,}}"
                                    placeholder="Password"
                                    title="8 characters minimum"
                                    name="password"
                                >
                                <span class="icon is-small is-left iconify" data-icon="mdi-wifi-lock"></span>
                            </p>
                        </div>
                    </div>
                </div>
                <div>
                    <div class = "control card-footer-item">
                        <input type="submit" value="Select", class = "button is-primary">
                    </div>
                </div>
            </form>
            </div>
        </div>
    </section>
</body>

</html>
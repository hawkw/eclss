<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ECLSS</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
<link rel="stylesheet" href="https://iosevka-webfonts.github.io/iosevka/iosevka.css" /> 
<script src="//code.iconify.design/1/1.0.6/iconify.min.js"></script>
<style type="text/css">
    /* tr.reading td {
        border-bottom: 2px solid lightgrey;
    }

    tr.reading td.kind {
        font-weight: bold;
    } */
    .reading.value {
        font-family: 'Iosevka Web';
    }

    p#temp .value::after {
        content:  " \00B0 C";
    }

    p#co2 .value::after {
        content: " ppm";
    }

    p#pressure .value::after {
        content: " hPa";
    }

    p#humidity .value::after {
        content: "%";
    }

    p#gas_resistance .value::after {
        content: " \2126";
    }
    </style>
    <script>
        async function updateSsids() {
            try {
                const ssids = await fetch('/wifi/ssids.json')
                    .then((response) => response.json());
                console.log(ssids);
                const ssidSelect = document.getElementById('ssids');
                ssids.forEach( ssid => {
                    let option = document.createElement("option");
                    option.textContent = ssid;
                    ssidSelect.appendChild(option);
                })
            } catch(error) {
                console.error('Error updating SSIDs: ', error);
            }
        }

        async function updateSensors() {
            const readingClasses = "reading value is-size-1-widescreen is-size-2-desktop is-size2-tablet is-size-3-mobile"
            try {
                const sensors = await fetch('/sensors.json').then((response) => response.json());

                console.log(sensors);
                for (const key in sensors) {
                    if (sensors.hasOwnProperty(key)) {
                        const reading = sensors[key];
                        const element = document.getElementById(key);
                        if (element) {
                            if (reading.hasOwnProperty('value')) {
                                // single sensor reading
                                let value = reading.value.toFixed(2);
                                element.innerHTML = `<span class='${readingClasses} has-text-centered'>${value}</span>`;
                            } else {
                                let html = '';
                                for (const sensorName in reading) {
                                    if (reading.hasOwnProperty(sensorName)) {
                                        let sensor = reading[sensorName];
                                        let value = sensor.value.toFixed(2);
                                        html += `<span class='${readingClasses} has-text-right'>${value}</span><span class='tag has-text-left'>${sensor.sensor}</span><br />`;
                                    }
                                }
                                element.innerHTML = html;
                            }
                        } else {
                            console.warn("No element named: ", key)
                        }
                    }
                }

            } catch(error) {
                console.error('Error updating sensor readings: ', error);
            }
        }

        setInterval(updateSensors, 2000);
        updateSensors();
        updateSsids();
    </script>
</head>
<body>
    <section class="hero is-primary">
        <div class="hero-body">
            <h1 class="title">
                ECLSS
            </h1>
            <p class="subtitle">
                Environmental Controls and Life Support Systems
            </p>
        </div>
    </section>
    <section class = "section">
        <nav class="level">
            <div class="level-item">
              <div class = ".reading">
                <p class="heading has-text-centered">
                    <span class="icon-text">
                        <span class="icon iconify" data-icon="mdi-temperature"></span>
                        <span>Temperature</span>
                    </span>
                </p>
                <p class="title" id="temp">--</p>
              </div>
            </div>
            <div class="level-item">
              <div class = ".reading">
                <p class="heading has-text-centered">
                    <span class="icon-text">
                        <span class="icon iconify" data-icon="mdi-molecule-co2"></span>
                        <span>Carbon Dioxide</span>
                    </span>
                <p class="title" id="co2">--</p>
              </div>
            </div>
            <div class="level-item">
                <div class = ".reading">
                    <p class="heading has-text-centered">
                        <span class="icon-text">
                            <span class="icon iconify" data-icon="mdi-cloud-download"></span>
                            <span>Barometric Pressure</span>
                        </span>
                    </p>
                    <p class="title" id="pressure">--</p>
                </div>
            </div>
            <div class="level-item">
                <div class = ".reading">
                    <p class="heading has-text-centered">
                        <span class="icon-text">
                            <span class="icon iconify" data-icon="mdi-water-percent"></span>
                            <span>Relative Humidity</span>
                        </span>
                    </p>
                    <p class="title" id="humidity">--</p>
                </div>
            </div>
            <div class="level-item">
                <div class = ".reading">
                    <p class="heading  has-text-centered">
                        <span class="icon-text">
                            <span class="icon iconify" data-icon="mdi-spray"></span>
                            <span>VOC Sensor Resistance</span>
                        </span>
                    </p>
                    <p class="title" id="gas_resistance">--</p>
                </div>
            </div>
          </nav>
    </section>
    <section class = "section">
        <div class = "panel">
            <p class="panel-heading">
                <span class="icon-text">
                    <span class="icon iconify" data-icon="mdi-wifi-cog"></span>
                    <span>WiFi</span>
                </span>
            </p>
            <div class="panel-block">
                <form
                    method="post" action="/wifi/select"
                    enctype="application/x-www-form-urlencoded">
                    <div>
                        <div class="field">
                            <label class="label">Access Point (SSID)</label>
                            <div class="control has-icons-left">
                                <span class="select">
                                    <select name="ssid" id="ssids"></select>
                                </span>
                                <span class="icon is-small is-left iconify" data-icon="mdi-access-point-network"></span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="field">
                            <label class="label">Password</label>
                            <div class="control has-icons-left">
                                <input
                                    class="input"
                                    type="password"
                                    pattern=".{{8,}}"
                                    placeholder="Password"
                                    title="8 characters minimum"
                                    name="password"
                                >
                                <span class="icon is-small is-left iconify" data-icon="mdi-wifi-lock"></span>
                            </p>
                        </div>
                    </div>
                </div>
                <div>
                    <div class = "control card-footer-item">
                        <input type="submit" value="Select", class = "button is-primary">
                    </div>
                </div>
            </form>
            </div>
        </div>
    </section>
</body>

</html>